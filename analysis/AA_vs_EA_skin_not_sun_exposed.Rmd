---
title: "AA_vs_EA"
author: "Tae Kim"
date: "3/23/2019"
output: pdf_document
---

```{r setup, include=FALSE}
set.seed(20190309)
knitr::opts_chunk$set(echo = TRUE,
                      dpi = 100,
                      fig.height = 3,
                      fig.width = 5)
library(MASS)
library(mvtnorm)
library(data.table)
library(nleqslv)
library(ggplot2)
library(KEGGREST)
library(biomaRt)
R.utils::sourceDirectory("R/", modifiedOnly=FALSE)
Rcpp::sourceCpp("../src/utilities.cpp")
ensembl = useMart("ENSEMBL_MART_ENSEMBL",
                dataset = "hsapiens_gene_ensembl")
```


# 1. Data pre-processing

We use the RNA-seq expression level data provided by GTEx, which has been already pre-processed. We choose to study not-sun-exposed suprapubic skin tissue as a pilot study because we expect to see some ancestry effect on the expression level on the skin tissue. Genes were selected based on expression threshold of $>0.1$ RPKM in at least 10 individuals and $\geq$ reads in at least 10 individuals. Then the expression values were quantile normalized to the average empirical distribution observed across samples. That means, each gene has the same distribution across the individuals. Then they were inverse quantile normalized to fit standard normal distribution.

## (a)load and clean the data

We read the expression level data and match the individuals with the ancestry information.

```{r dataclean, echo = FALSE}
load("../data/skin_not_sun_exposed_suprapubic.Rdata")
exp = skin; rm(skin)
colnames(exp) = gsub("[.]", "-", colnames(exp))
ind = which(colSums(!is.na(exp)) == 0)
exp = exp[,-ind]
ind= which(rowSums(!is.na(exp)) == 0)
exp = exp[-ind, ]
invisible(gc())
finalA = read.table("../data/finalA.txt", header=TRUE)
AAs = intersect(colnames(exp), finalA$subject)
EAs = colnames(exp)[! colnames(exp) %in% finalA$subject]
newA= data.frame(subject = AAs, A = finalA[match(AAs, finalA$subject), 2])
Y = exp[, c(AAs, EAs)]
rm(exp); invisible(gc())
EA_A = data.frame(subject = EAs, A = 0)
X = rbind(newA, EA_A)
rm(newA, EA_A, AAs, EAs, ind, finalA)
rownames(Y) = sapply(strsplit(rownames(Y), '[.]'), function(x) x[1])
Y = t(Y)
orig = Y
dim(Y)
```

## (b) scale the data and regress out the mean

We code African Americans as 0 and European Americans as 1 to compare group by group coexpression difference. We also consider correlation matrix, so we scale the gene expression level matrix to have variance 1. Then we regress out ancestry from the gene expression level to remove the mean effect. 

```{r scale}
orig_A = X$A
X$A[X$A > 0] = 1
X$A = scale(X$A) * sqrt(length(X$A)) / sqrt(length(X$A)-1)
Y = resid(lm(Y~X$A))
# Y = scale(Y) * sqrt(length(X$A)) / sqrt(length(X$A)-1)
```


```{r, echo=FALSE}
ref_chisq = qchisq(seq(0,1, length=ncol(Y)-1), 1)
```

```{r, echo = FALSE}
B = 2000
```



# 2. Gene selection

In order to avoid extensive multiple testing, we use prior information in biology. 

## (a) KEGG pathway

We believe the disease pathways may reflect the gene-gene correlation structure or gene modules, so we choose three pathways that are related to either skin tissue or immunity - melonoma, asthma, and autoimmune disease. 

For each pathway, we take a group of $K$ genes and for each $k$ in $1, \cdots, K$, we compute $d_k$ and compare it to the empirical distribution by permuting the ancestry. Then we show qqplot of the p values against the uniform distribution after transformation $-log_{10}(p)$.

```{r, echo=FALSE}
get_result_kegg = function(hsacode, B){
  out = keggGet(hsacode)
  out = out[[1]]
  genes = sapply(strsplit(out$GENE, ";"), function(x) x[1])
  genes = genes[seq(2,144,by=2)]
  results = getBM(attributes = c('hgnc_symbol','ensembl_gene_id'),
                filters = "hgnc_symbol",
                values = genes,
                mart = ensembl)
  genes = colnames(Y)[which(colnames(Y) %in% results$ensembl_gene_id)]
  results = results[match(genes, results$ensembl_gene_id), ]
  R = Y[,genes]
  d = rep(0, ncol(R))
  p = rep(0, ncol(R))
  for (i in 1:ncol(R)){
    d[i] = get_degree_c(X$A, R[,i], R[,-i])
    storeW = store_W_c(R[,i], R[,-i])
    out = rowSums(bootstrap_c(X$A, B, storeW))
    p[i] = sum(out > d[i]) / B
  }
  return(list(p = p, d = d, genes = results))
}

out = get_result_kegg("hsa05218", B) #melanoma disease
par(mfrow = c(1,2))
qqplot(-log(seq(0,1,length.out = length(out$p))), -log(out$p),
     xlab = '-log uniform',
     ylab = '-log p',
     main = "melanoma")
abline(0,1,col = 'red')

df = data.frame(p = -log(out$p), genes = out$genes$hgnc_symbol, ind = 1:length(out$p))
plot(-log(out$p), 
     ylab = '-log p', 
     main = '-log(p) values',
     xlim = c(0, length(out$p)+10))
ind = which(df$p > 3)
df = df[ind, ]
with(df, text(p ~ ind, labels = genes, pos = 4))

out = get_result_kegg("hsa05310", B) #asthma
par(mfrow = c(1,2))
qqplot(-log(seq(0,1,length.out = length(out$p))), -log(out$p),
     xlab = '-log uniform',
     ylab = '-log p',
     main = "asthma")
abline(0,1,col = 'red')

df = data.frame(p = -log(out$p), genes = out$genes$hgnc_symbol, ind = 1:length(out$p))
plot(-log(out$p), 
     ylab = '-log p', 
     main = '-log(p) values',
     xlim = c(0, length(out$p)+10))
ind = which(df$p > 3)
df = df[ind, ]
with(df, text(p ~ ind, labels = genes, pos = 4))


out = get_result_kegg("hsa05320", B) #autoimmune
par(mfrow = c(1,2))
qqplot(-log(seq(0,1,length.out = length(out$p))), -log(out$p),
     xlab = '-log uniform',
     ylab = '-log p',
     main = "auto immune")
abline(0,1,col = 'red')

df = data.frame(p = -log(out$p), genes = out$genes$hgnc_symbol, ind = 1:length(out$p))
plot(-log(out$p), 
     ylab = '-log p', 
     main = '-log(p) values',
     xlim = c(0, length(out$p)+10))
ind = which(df$p > 3)
df = df[ind, ]
with(df, text(p ~ ind, labels = genes, pos = 4))
```

\pagebreak

## (b) HLA genes

We know that HLA genes are connected to many other genes and play critical role in regulating the gene transcription. We obtain the list of HLA genes and compute $d_1$ by adding up pair-wise test statistics across the entire genome. 

```{r}
hla_genes = c("HLA-A", "HLA-B", "HLA-C", "HLA-E", 
              "HLA-F", "HLA-G", "HLA-H", "HLA-J", 
              "HLA-K", "HLA-L", "HLA-N", "HLA-P", 
              "HLA-S", "HLA-T", "HLA-U", "HLA-V", 
              "HLA-W", "HLA-X", "HLA-Y", "HLA-Z",
              "HLA-DRA", "HLA-DRB2", "HLA-DRB3",
              "HLA-DRB4", "HLA-DRB5", "HLA-DRB6",
              "HLA-DRB7", "HLA-DRB8", "HLA-DRB9",
              "HLA-DQA1", "HLA-DQB1", "HLA-DQA2",
              "HLA-DQB2", "HLA-DQB3", "HLA-DOA",
              "HLA-DMA", "HLA-DMB", "HLA-DPA1", "HLA-DPB1",
              "HLA-DPA2", "HLA-DPB2", "HLA-DPA3",
              "HFE", "TAP1", "TAP2", "PSMB9", "PSMB8",
              "MICA", "MICB", "MICC", "MICD", "MICE")

results = getBM(attributes = c('hgnc_symbol','ensembl_gene_id'), 
                filters = "hgnc_symbol",
                values = hla_genes,
                mart = ensembl)

genes = colnames(Y)[which(colnames(Y) %in% results$ensembl_gene_id)]
results = results[match(genes, results$ensembl_gene_id), ]

scores = newscores = matrix(0, length(genes), ncol(Y)-1)
coef = cubic_coeff_c(X$A, qchisq(1-0.05/ncol(Y), 1), 2, 2)
for (i in 1:length(genes)){
  ind = which(colnames(Y) == results$ensembl_gene_id[i])
  W = store_W_c(Y[,ind], Y[, -ind])
  scores[i,] = get_score_W_c(X$A, W)
  for (j in 1:ncol(scores)){
    roots = polyroot(c(-scores[i,j], coef))
    newscores[i,j] = Re(roots)[abs(Im(roots)) < 1e-6]
  }
}
```

And the result is plotted below, where the red line is the expected mean. HLA-DQA1 stands out in its test statistic.

```{r, echo = FALSE}
par(mfrow = c(1,2))
d = rowSums(newscores)
df = data.frame(d = d, genes = results$hgnc_symbol, xaxis = 1:length(d))
plot(d, 
     ylab = 'd', 
     main = 'HLA-genes',
     xlim = c(0,45),
     ylim = c(0, max(d) + 100))
abline(h=25190, col='red')
ind = which(d > 2*ncol(Y))
df = df[ind, ]
with(df, text(d ~ xaxis, labels = genes, pos = 4))

ref_chisq = qchisq(seq(0,1,length=length(newscores[1,])), 1)
ind = which(results$hgnc_symbol == "HLA-DQA1")
qqplot(ref_chisq, newscores[ind,],  main = 'HLA-DQA1 scores', ylab='scores'); abline(0,1,col = 'red')
```



## (c) Transcription Factors

### read TF data

Since transcription factors usually regulate the transcription of multiple genes, we thought they were appropriate targets to study their variance in activity across different ancestry. 

```{r}
TF = fread("../data/TFcheckpoint.txt", header=TRUE)
TF = setDF(TF)
TF = TF[,1]
results = getBM(attributes = c('hgnc_symbol','ensembl_gene_id'), 
                filters = "hgnc_symbol",
                values = TF,
                mart = ensembl)

genes = colnames(Y)[which(colnames(Y) %in% results$ensembl_gene_id)]
results = results[match(genes, results$ensembl_gene_id), ]
```


### test all the TFs

```{r}
par(mfrow = c(1,2))
scores = matrix(0, length(genes), ncol(Y)-1)
for (i in 1:length(genes)){
  ind = which(colnames(Y) == results$ensembl_gene_id[i])
  W = store_W_c(Y[,ind], Y[, -ind])
  scores[i,] = get_score_W_c(X$A, W)
}

d = rowSums(scores)
df = data.frame(d = d, genes = results$hgnc_symbol, xaxis = 1:length(d))
plot(d, 
     ylab = 'd', 
     main = 'Transcription Factors')
abline(h=25190, col='red')
ind = which(d > ncol(Y) + 200 * sqrt(2*ncol(Y)))
df = df[ind, ]
with(df, text(d ~ xaxis, labels = genes, pos = 4))

ref_chisq = qchisq(seq(0,1, length=ncol(Y)-1), 1)
for (i in 1:length(genes)){
    if(results$hgnc_symbol[i] %in% c("FOXM1")){
      qqplot(ref_chisq, scores[i, ], 
            main = paste(results$hgnc_symbol[i], 'unadjusted'),
            cex = 0.5)
      abline(0,1,col = 'red')
  }
}
```

\pagebreak

# Investigating the top signals

## HLA-DQA1

### HLA-DQA1 Score test

We re-cap what we have observed in HLA-DQA1 for the score tests.

```{r, echo = FALSE}
hla_genes = "HLA-DQA1"
results = getBM(attributes = c('hgnc_symbol','ensembl_gene_id'),
                filters = "hgnc_symbol",
                values = hla_genes,
                mart = ensembl)

dqa_ind = which(colnames(Y) %in% c(results$ensembl_gene_id))
smallY = Y[,-dqa_ind]
s = news = rep(0, ncol(Y)-1)
for (i in 1:(ncol(Y)-1)){
  s[i] = get_score_c(X$A, Y[,dqa_ind], smallY[,i])
}
plot(sort(s) ~ qchisq(seq(0,1,length=ncol(Y)-1), 1),
     type = 'l',
     main = 'pairwise scores',
     xlab = 'reference chi1',
     ylab = 'sorted scores'); 
abline(0,1,col = 'red')
```

### HLA-DQA1, permutation test

In order to verify if HLA-DQA truly has a signal, we perform permutation test. The p-value is indeed very small.

```{r}
W = store_W_c(Y[,dqa_ind], Y[, -dqa_ind])
dqa_scores = get_score_W_c(X$A, W)
dqa_d = get_degree_c(X$A, Y[,dqa_ind], Y[,-dqa_ind])
# shuffled_A = shuffle_x_c(X$A, B)
storeW = store_W_c(Y[,dqa_ind], Y[,-dqa_ind])
out = bootstrap_c(X$A, B, storeW)
bootstrapped_d = rowSums(out)
dqa_p = sum(bootstrapped_d > dqa_d) / B
hist(bootstrapped_d, 50, xlim = c(10000, max(max(bootstrapped_d), dqa_d))+20)
abline(v=dqa_d, col = 'red')
print(dqa_p)
# par(mfrow = c(2,3))
# for (i in 1:12){
#   qqplot(ref_chisq, out[i, ], cex = 0.5, type = 'l', ylab = 'permuted score')
#   abline(0,1,col = 'red')
# }
```


### Genes with the highest scores for HLA-DQA1

We make some diagnosis plot to observe what is driving the signal. 

```{r}
max_scores = sort(s, decreasing=TRUE, index.return=TRUE)
results = getBM(attributes = c('hgnc_symbol','ensembl_gene_id'),
                filters = "ensembl_gene_id",
                values = colnames(Y[,-dqa_ind])[max_scores$ix[1:10]],
                mart = ensembl)
results = results[match(results$ensembl_gene_id, colnames(Y[,-dqa_ind])[max_scores$ix[1:10]]), ]
top_genes = data.frame(gene_name = results$hgnc_symbol, score = max_scores$x[1:10],
                ensembl = results$ensembl_gene_id)
# print(top_genes)
AA_ind = which(orig_A > 0)
EA_ind = which(orig_A == 0)
diff_cor = data.frame(genes = top_genes$gene_name,
                      AA = as.numeric(cor(orig[AA_ind,dqa_ind], 
                                          (orig[AA_ind,-dqa_ind])[, max_scores$ix[1:10]])),
                      EA = as.numeric(cor(orig[EA_ind,dqa_ind], 
                                          (orig[EA_ind,-dqa_ind])[, max_scores$ix[1:10]])))
print(cbind(top_genes, diff_cor[,2:3]))
```

### The expression level of HLA-DQA1's top signal LRBA

```{r}
AA_ind = which(orig_A > 0)
EA_ind = which(orig_A == 0)
diff_cor = data.frame(genes = top_genes$gene_name,
                      AA = as.numeric(cor(orig[AA_ind,dqa_ind], 
                                          (orig[AA_ind,-dqa_ind])[, max_scores$ix[1:10]])),
                      EA = as.numeric(cor(orig[EA_ind,dqa_ind], 
                                          (orig[EA_ind,-dqa_ind])[, max_scores$ix[1:10]])))
print(diff_cor)

par(mfrow = c(1,2))
plot(orig[AA_ind, dqa_ind] ~ orig[AA_ind,-dqa_ind][, max_scores$ix[1]],
     main = 'African Americans',
     xlab = 'LRBA',
     ylab = 'HLA-DQA1')
plot(orig[EA_ind, dqa_ind] ~ orig[EA_ind,-dqa_ind][, max_scores$ix[1]],
     main = 'European Americans',
     xlab = 'LRBA',
     ylab = 'HLA-DQA1')
```

### HLA-DQA1, box plot

```{r}
AA_ind = which(orig_A > 0)
EA_ind = which(orig_A == 0)
dqa_exp = as.matrix(orig[,dqa_ind])
dqa_exp_aa = dqa_exp[AA_ind]
dqa_exp_ea = dqa_exp[EA_ind]

df = data.frame(exp = dqa_exp, label = c(rep("African_Amsericans", length(AA_ind)),rep("European_Americans", length(EA_ind))))

boxplot(exp ~ label, data = df, lwd = 2, main = "distribution of expression of HLA-DQA1")
stripchart(exp ~ label, vertical = TRUE, data = df, 
    method = "jitter", add = TRUE, pch = 4, col = 'blue', cex=0.5)
```


\pagebreak 

## FOXM1

### FOXM1 Score test

```{r}
gene = "FOXM1"
results = getBM(attributes = c('hgnc_symbol','ensembl_gene_id'),
                filters = "hgnc_symbol",
                values = gene,
                mart = ensembl)

fox_ind = which(colnames(Y) %in% c(results$ensembl_gene_id))
smallY = Y[,-fox_ind]
s = news = rep(0, ncol(Y)-1)
for (i in 1:(ncol(Y)-1)){
  s[i] = get_score_c(X$A, Y[,fox_ind], smallY[,i])
}
plot(sort(s) ~ qchisq(seq(0,1,length=ncol(Y)-1), 1), type = 'l'); abline(0,1,col = 'red', main = 'adjusted')
```

### FOXM1, permutation test

We conduct the permutation test to see if the signal is real.

```{r}
fox_ind = which(colnames(Y) %in% results[results$hgnc_symbol=="FOXM1", 2])
W = store_W_c(Y[,fox_ind], Y[, -fox_ind])
fox_scores = get_score_W_c(X$A, W)
fox_d = get_degree_c(X$A, Y[,fox_ind], Y[,-fox_ind])
shuffled_A = shuffle_x_c(X$A, B)
storeW = store_W_c(Y[,fox_ind], Y[,-fox_ind])
out = bootstrap_c(X$A, B, storeW)
bootstrapped_d = rowSums(out)
fox_p = sum(bootstrapped_d > fox_d) / B
par(mfrow = c(1,1))
hist(bootstrapped_d, 50, xlim = c(10000, max(max(bootstrapped_d), fox_d))+100)
abline(v=fox_d, col = 'red')
print(fox_p)
# par(mfrow = c(2,3))
# for (i in 1:12){
#   qqplot(ref_chisq, out[i, ], cex = 0.5, type = 'l', ylab = 'permuted score')
#   abline(0,1,col = 'red')
# }
```

## FOXM1, box plot

We inspect the raw data to see any patterns between Afircan Americans and European Americans.

```{r}
AA_ind = which(orig_A > 0)
EA_ind = which(orig_A == 0)
fox_exp = as.matrix(orig[,fox_ind])
fox_exp_aa = fox_exp[AA_ind]
fox_exp_ea = fox_exp[EA_ind]

df = data.frame(exp = fox_exp, label = c(rep("African Americans", length(AA_ind)),rep("European Americans", length(EA_ind))))

boxplot(exp ~ label, data = df, lwd = 2, main = "distribution of expression of FOXM1")
stripchart(exp ~ label, vertical = TRUE, data = df, 
    method = "jitter", add = TRUE, pch = 4, col = 'blue', cex=0.5)

```

## Correlation of HLA-DQA1 and FOXM1 against all other genes

```{r}
diff_cor_fox = data.frame(genes = colnames(orig)[-fox_ind],
                      AA = as.numeric(cor(orig[AA_ind,fox_ind], 
                                          (orig[AA_ind,-fox_ind]))),
                      EA = as.numeric(cor(orig[EA_ind,fox_ind], 
                                          (orig[EA_ind,-fox_ind]))))
diff_cor_dqa = data.frame(genes = colnames(orig)[-dqa_ind],
                      AA = as.numeric(cor(orig[AA_ind,dqa_ind], 
                                          (orig[AA_ind,-dqa_ind]))),
                      EA = as.numeric(cor(orig[EA_ind,dqa_ind], 
                                          (orig[EA_ind,-dqa_ind]))))
par(mfrow = c(1,2))
plot(diff_cor_dqa$AA ~ diff_cor_dqa$EA, cex=0.3, ylim = c(-1,1), xlim = c(-1,1), main='HLA-DQA1',
     ylab = 'African Americans',
     xlab = 'European Americans'); abline(0,1,col = 'red')

plot(diff_cor_fox$AA ~ diff_cor_fox$EA, cex=0.3, ylim = c(-1,1), xlim = c(-1,1), main='FOXM1',
     ylab = 'African Americans',
     xlab = 'European Americans'); abline(0,1,col = 'red')
```


## What happens when I reduce the sample size of European Americans?

```{r}
EA_subset = sample(EA_ind, size=31)

diff_cor_fox = data.frame(genes = colnames(orig)[-fox_ind],
                      AA = as.numeric(cor(orig[AA_ind,fox_ind], 
                                          (orig[AA_ind,-fox_ind]))),
                      EA = as.numeric(cor(orig[EA_subset,fox_ind], 
                                          (orig[EA_subset,-fox_ind]))))
diff_cor_dqa = data.frame(genes = colnames(orig)[-dqa_ind],
                      AA = as.numeric(cor(orig[AA_ind,dqa_ind], 
                                          (orig[AA_ind,-dqa_ind]))),
                      EA = as.numeric(cor(orig[EA_subset,dqa_ind], 
                                          (orig[EA_subset,-dqa_ind]))))
par(mfrow = c(1,2))
plot(diff_cor_dqa$AA ~ diff_cor_dqa$EA, cex=0.3, ylim = c(-1,1), xlim = c(-1,1), main='HLA-DQA1',
     ylab = 'African Americans',
     xlab = 'European Americans'); abline(0,1,col = 'red')

plot(diff_cor_fox$AA ~ diff_cor_fox$EA, cex=0.3, ylim = c(-1,1), xlim = c(-1,1), main='FOXM1',
     ylab = 'African Americans',
     xlab = 'European Americans'); abline(0,1,col = 'red')
```


## Repeat HLA-DQA1 with sampled Euopreans

```{r}
W = store_W_c(Y[c(AA_ind, EA_subset),dqa_ind], Y[c(AA_ind, EA_subset), -dqa_ind])
dqa_scores = get_score_W_c(X$A[c(AA_ind, EA_subset)], W)
dqa_d = get_degree_c(X$A[c(AA_ind, EA_subset)], Y[c(AA_ind, EA_subset),dqa_ind], Y[c(AA_ind, EA_subset),-dqa_ind])
storeW = store_W_c(Y[c(AA_ind, EA_subset),dqa_ind], Y[c(AA_ind, EA_subset),-dqa_ind])
out = bootstrap_c(X$A[c(AA_ind, EA_subset)], B, storeW)
bootstrapped_d = rowSums(out)
dqa_p = sum(bootstrapped_d > dqa_d) / B
hist(bootstrapped_d, 50, xlim = c(10000, max(max(bootstrapped_d), dqa_d))+20)
abline(v=dqa_d, col = 'red')
print(dqa_p)
```

## Repeat FOX-M1 with sampled Euopreans

```{r}
W = store_W_c(Y[c(AA_ind, EA_subset),fox_ind], Y[c(AA_ind, EA_subset), -fox_ind])
fox_scores = get_score_W_c(X$A[c(AA_ind, EA_subset)], W)
fox_d = get_degree_c(X$A[c(AA_ind, EA_subset)], Y[c(AA_ind, EA_subset),fox_ind], Y[c(AA_ind, EA_subset),-fox_ind])
storeW = store_W_c(Y[c(AA_ind, EA_subset),fox_ind], Y[c(AA_ind, EA_subset),-fox_ind])
out = bootstrap_c(X$A[c(AA_ind, EA_subset)], B, storeW)
bootstrapped_d = rowSums(out)
fox_p = sum(bootstrapped_d > fox_d) / B
hist(bootstrapped_d, 50, xlim = c(10000, max(max(bootstrapped_d), fox_d))+20)
abline(v=fox_d, col = 'red')
print(fox_p)
```


